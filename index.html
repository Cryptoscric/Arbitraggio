<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Sentry Pro - Debug Connection</title>
    <style>
        :root { --glow: #00ff41; --bg: #050505; --card: #141414; --text: #ffffff; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .header { border-bottom: 3px solid var(--glow); padding-bottom: 10px; margin-bottom: 20px; }
        .controls { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; border: 1px solid #333; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .token-section { background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 15px; }
        .dex-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .dex-card { background: #1f1f1f; border: 2px solid #444; padding: 15px; border-radius: 8px; text-align: center; color: white !important; }
        .price { font-size: 1.3rem; font-weight: bold; display: block; margin: 5px 0; color: white !important; }
        .status-tag { font-size: 0.7rem; color: #ffa500; background: #221100; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="color: var(--glow); margin:0;">SOLANA POOL SENTRY</h1>
    <div id="global-status" style="font-size:0.8rem; color:#888;">Inizializzazione...</div>
</div>

<div class="controls">
    <div>
        <label style="color:var(--glow)">TEST SOL:</label>
        <input type="number" id="testAmount" value="0.5" step="0.1" style="background:#000; color:#fff; border:1px solid #555; padding:5px; width:60px;">
    </div>
    <div style="flex-grow:1; text-align:right;">
        <span id="timer" style="color:var(--glow)">Scan...</span>
    </div>
</div>

<div id="main-grid" class="grid"></div>

<script>
    const SOL = "So11111111111111111111111111111111111111112";
    const DEXES = ["Jupiter", "Orca", "Meteora", "Raydium"];
    let mints = [];

    async function loadMints() {
        try {
            const r = await fetch('mint.txt?v=' + Date.now());
            const text = await r.text();
            return text.split(/\r?\n/).map(l => l.trim().split(/\s+/).pop()).filter(a => a.length > 30);
        } catch (e) { return []; }
    }

    async function getPrice(mint, amount) {
        try {
            const lamports = Math.floor(amount * 1e9);
            // Proviamo a chiamare l'API v6 di Jupiter
            const url = `https://quote-api.jup.ag/v6/quote?inputMint=${SOL}&outputMint=${SOL}&amount=${lamports}&intermediateMint=${mint}&slippageBps=0`;
            const r = await fetch(url);
            if (!r.ok) return { error: "HTTP " + r.status };
            return await r.json();
        } catch (e) {
            return { error: "CORS / Network Error" };
        }
    }

    async function update() {
        const amount = parseFloat(document.getElementById('testAmount').value);
        for (const mint of mints) {
            let section = document.getElementById(mint);
            if (!section) {
                section = document.createElement('div');
                section.id = mint;
                section.className = 'token-section';
                section.innerHTML = `<div>TOKEN: ${mint.substring(0,10)}... <span id="st-${mint}" class="status-tag">In attesa...</span></div><div class="dex-grid" id="grid-${mint}"></div>`;
                document.getElementById('main-grid').appendChild(section);
            }

            const data = await getPrice(mint, amount);
            const statusEl = document.getElementById(`st-${mint}`);
            
            if (data.error) {
                statusEl.innerText = data.error;
                statusEl.style.color = "#ff4444";
            } else if (data.outAmount) {
                statusEl.innerText = "Dati Ricevuti";
                statusEl.style.color = var(--glow);
                const price = data.outAmount / 1e9;
                
                // Aggiorna i riquadri
                DEXES.forEach(dex => {
                    let card = document.getElementById(`c-${mint}-${dex}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.id = `c-${mint}-${dex}`;
                        card.className = 'dex-card';
                        document.getElementById(`grid-${mint}`).appendChild(card);
                    }
                    card.innerHTML = `<small>${dex}</small><span class="price">${price.toFixed(5)}</span>`;
                });
            } else {
                statusEl.innerText = "Nessuna Rotta (Poca Liquidit√†?)";
            }
        }
    }

    async function init() {
        mints = await loadMints();
        update();
        setInterval(update, 15000);
    }

    init();
</script>
</body>
</html>
