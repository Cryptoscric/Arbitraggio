<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Arb Sentry - Repair Mode</title>
    <style>
        :root { --glow: #00ff41; --bg: #050505; --card: #141414; --text: #ffffff; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .header { border-bottom: 3px solid var(--glow); padding-bottom: 15px; margin-bottom: 25px; }
        .controls { background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #333; display: flex; gap: 20px; align-items: center; }
        .timer-container { flex-grow: 1; text-align: right; }
        #progress-bar { width: 100%; height: 8px; background: #222; border-radius: 4px; margin-top: 5px; }
        #progress { height: 100%; background: var(--glow); width: 0%; transition: width 1s linear; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .token-section { background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 15px; }
        .dex-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .dex-card { background: #1f1f1f; border: 2px solid #444; padding: 15px; border-radius: 8px; text-align: center; color: white !important; }
        .dex-card.active { border-color: var(--glow); background: #002200; }
        .price { font-size: 1.3rem; font-weight: bold; display: block; margin: 5px 0; }
        .pct { font-weight: bold; padding: 2px 5px; border-radius: 3px; }
        .pos { color: #00ff41; } .neg { color: #ff3333; }
        #debug-console { background: #000; color: #ffa500; padding: 10px; font-size: 0.8rem; border: 1px solid #444; margin-bottom: 20px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="color: var(--glow); margin:0;">SOLANA ARB SENTRY <span style="font-size:0.8rem;">(REPAIR MODE)</span></h1>
</div>

<div id="debug-console">Inizializzazione... Controlla se i Mint vengono letti correttamente.</div>

<div class="controls">
    <div>
        <label style="color:var(--glow); font-weight:bold;">TEST SOL:</label>
        <input type="number" id="testAmount" value="5" style="width:60px; background:#000; color:#fff; border:1px solid #555;">
    </div>
    <div class="timer-container">
        <span id="timer-text" style="color:var(--glow)">Scan in corso...</span>
        <div id="progress-bar"><div id="progress"></div></div>
    </div>
</div>

<div id="main-grid" class="grid"></div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    const SOL_ADDR = "So11111111111111111111111111111111111111112";
    const DEXES = [
        { id: "Jupiter", label: "JUPITER BEST" },
        { id: "Orca", label: "ORCA" },
        { id: "Meteora", label: "METEORA" },
        { id: "Raydium", label: "RAYDIUM" }
    ];

    let mints = [];
    const interval = 15;
    let secondsLeft = interval;

    function log(msg) {
        const console = document.getElementById('debug-console');
        console.innerHTML += `> ${msg}<br>`;
        console.scrollTop = console.scrollHeight;
    }

    async function loadMints() {
        try {
            const r = await fetch('mint.txt?v=' + Date.now());
            const text = await r.text();
            // Pulisce in modo aggressivo ogni riga del file
            const cleanMints = text.split(/\r?\n/)
                                   .map(line => line.trim())
                                   .filter(line => line.length > 0)
                                   .map(line => {
                                       const parts = line.split(/\s+/);
                                       return parts[parts.length - 1]; // Prende l'ultima parola (l'indirizzo)
                                   })
                                   .filter(addr => addr.length >= 32 && addr.length <= 48);
            
            log(`Trovati ${cleanMints.length} indirizzi validi.`);
            return cleanMints;
        } catch (e) {
            log("ERRORE: Impossibile leggere mint.txt");
            return [];
        }
    }

    async function getPrice(mint, dexId, amount) {
        try {
            const lamports = Math.floor(amount * 1e9);
            // Costruzione URL semplificata
            let url = `https://quote-api.jup.ag/v6/quote?inputMint=${SOL_ADDR}&outputMint=${SOL_ADDR}&amount=${lamports}&intermediateMint=${mint}&slippageBps=0`;
            
            if (dexId !== "Jupiter") {
                url += `&dexes=${dexId}&onlyDirectRoutes=true`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data;
        } catch (e) {
            return null;
        }
    }

    async function runScan() {
        const testVal = parseFloat(document.getElementById('testAmount').value) || 5;
        const grid = document.getElementById('main-grid');
        
        log("Inizio scansione prezzi...");

        for (const mint of mints) {
            let section = document.getElementById('sec-' + mint);
            if (!section) {
                section = document.createElement('div');
                section.id = 'sec-' + mint;
                section.className = 'token-section';
                section.innerHTML = `<div style="color:var(--glow); border-bottom:1px solid #333; padding-bottom:5px;">TOKEN: ${mint}</div><div class="dex-grid" id="grid-${mint}"></div>`;
                grid.appendChild(section);
            }

            const dexGrid = document.getElementById('grid-' + mint);

            for (const dex of DEXES) {
                const data = await getPrice(mint, dex.id, testVal);
                let card = document.getElementById(`card-${mint}-${dex.id}`);
                
                if (!card) {
                    card = document.createElement('div');
                    card.id = `card-${mint}-${dex.id}`;
                    card.className = 'dex-card';
                    dexGrid.appendChild(card);
                }

                if (data && data.outAmount) {
                    const out = data.outAmount / 1e9;
                    const pct = ((out - testVal) / testVal) * 100;
                    card.innerHTML = `
                        <div style="font-size:0.7rem; color:#aaa;">${dex.label}</div>
                        <span class="price">${out.toFixed(5)} SOL</span>
                        <span class="pct ${pct >= 0 ? 'pos' : 'neg'}">${pct >= 0 ? '+' : ''}${pct.toFixed(4)}%</span>
                    `;
                    if(pct > 0.01) document.getElementById('beep').play().catch(()=>{});
                } else {
                    card.innerHTML = `<div style="font-size:0.7rem; color:#aaa;">${dex.label}</div><span style="color:#555; display:block; margin-top:10px;">NON DISPONIBILE</span>`;
                }
            }
        }
        log("Scansione completata.");
    }

    function timer() {
        secondsLeft--;
        document.getElementById('progress').style.width = ((interval - secondsLeft) / interval * 100) + "%";
        document.getElementById('timer-text').innerText = `Prossimo scan: ${secondsLeft}s`;
        
        if (secondsLeft <= 0) {
            secondsLeft = interval;
            runScan();
        }
    }

    async function init() {
        mints = await loadMints();
        if (mints.length > 0) {
            runScan();
            setInterval(timer, 1000);
        }
    }

    init();
</script>
</body>
</html>
