<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ARB SENTRY - Terminale Operativo</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        :root { --glow: #00ff41; --bg: #050505; --card: #121212; --text: #e0e0e0; --red: #ff3333; --magenta: #ff00ff; --blue: #008cff; }
        body { font-family: 'Segoe UI', Consolas, monospace; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        .header { border-bottom: 2px solid var(--glow); padding-bottom: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .controls { background: #111; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        
        .control-group { display: flex; align-items: center; gap: 8px; }
        .controls label { font-size: 0.7rem; font-weight: 800; color: var(--glow); text-transform: uppercase; }
        .controls input { background: #2a2a2a; color: var(--glow); border: 1px solid #444; padding: 4px; border-radius: 4px; width: 80px; font-size: 0.9rem; text-align: center; }
        
        #wallet-btn { background: var(--blue); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #wallet-btn.connected { background: var(--glow); color: black; }

        .token-section { background: var(--card); border: 1px solid #222; border-radius: 10px; padding: 12px; margin-bottom: 15px; }
        .token-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .token-info .name { color: var(--glow); font-size: 1rem; font-weight: 900; }
        
        .dex-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .dex-card { background: #181818; border: 1px solid #333; padding: 10px; border-radius: 6px; text-align: center; position: relative; }
        
        /* Bottoni Azione */
        .btn-action { width: 45%; padding: 5px; font-size: 0.65rem; font-weight: bold; border: none; border-radius: 3px; cursor: pointer; margin-top: 8px; text-transform: uppercase; }
        .btn-buy { background: var(--glow); color: black; margin-right: 4px; }
        .btn-sell { background: var(--red); color: white; }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; }

        .price { font-size: 0.9rem; font-weight: 800; display: block; margin: 5px 0; }
        .gap-value { font-size: 1.2rem; font-weight: 900; color: #444; }
        .blink-green { color: var(--glow) !important; animation: blink 0.6s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    </style>
</head>
<body>

<div class="header">
    <h2 style="color: var(--glow); margin:0;">ARB SENTRY - TERMINAL</h2>
    <button id="wallet-btn" onclick="connectWallet()">CONNETTI WALLET</button>
</div>

<div class="controls">
    <div class="control-group">
        <label>ORDINE SOL:</label>
        <input type="number" id="trade-amount" value="0.1" step="0.1">
    </div>
    <div id="status-msg" style="font-size: 0.7rem; color: #888;">Pronto per l'azione...</div>
</div>

<div id="main-grid"></div>

<script>
    const TARGET_DEX_IDS = ["Raydium", "Orca", "Meteora"];
    let mints = [];
    let userWallet = null;
    const SOL_MINT = "So11111111111111111111111111111111111111112";

    // --- LOGICA WALLET ---
    async function connectWallet() {
        if (window.solana) {
            try {
                const resp = await window.solana.connect();
                userWallet = resp.publicKey.toString();
                const btn = document.getElementById('wallet-btn');
                btn.innerText = userWallet.substring(0, 6) + "... Connected";
                btn.className = "connected";
                scan(); 
            } catch (err) { console.error("User rejected", err); }
        } else { alert("Installa Phantom!"); }
    }

    // --- LOGICA TRADING (JUPITER) ---
    async function executeSwap(mode, targetMint, dexForce) {
        if (!userWallet) return alert("Connetti il wallet prima!");
        const status = document.getElementById('status-msg');
        status.innerText = `Preparazione ${mode} su ${dexForce}...`;

        try {
            const amount = document.getElementById('trade-amount').value * 1e9; // Converte SOL in lamports
            const input = mode === 'BUY' ? SOL_MINT : targetMint;
            const output = mode === 'BUY' ? targetMint : SOL_MINT;
            
            // Se vendiamo, cerchiamo di vendere tutto (idealmente servirebbe fetch balance, qui usiamo input simbolico o amount)
            const tradeQty = mode === 'BUY' ? amount : "1000000000"; // Esempio: vendi 1 token (va adattato a decimali reali)

            // 1. Get Quote da Jupiter forzando il DEX
            const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${input}&outputMint=${output}&amount=${tradeQty}&dexes=${dexForce}&slippageBps=100`;
            const quoteResponse = await (await fetch(quoteUrl)).json();

            if (!quoteResponse.outAmount) throw new Error("Nessuna rotta su " + dexForce);

            // 2. Get Serialized Transaction
            const { swapTransaction } = await (await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quoteResponse,
                    userPublicKey: userWallet,
                    wrapAndUnwrapSol: true,
                })
            })).json();

            // 3. Firma e invia
            const transactionBase64 = swapTransaction;
            const transaction = solanaWeb3.Transaction.from(Uint8Array.from(atob(transactionBase64), c => c.charCodeAt(0)));
            
            const { signature } = await window.solana.signAndSendTransaction(transaction);
            status.innerText = `Inviato! Sig: ${signature.substring(0,10)}...`;
            
        } catch (e) {
            status.innerText = "Errore: " + e.message;
            console.error(e);
        }
    }

    // --- LOGICA SCANNER (DEXSCREENER) ---
    async function scan() {
        const grid = document.getElementById('main-grid');
        const r = await fetch('mint.txt?v=' + Date.now());
        const t = await r.text();
        mints = t.split(/\n/).map(l => l.trim()).filter(a => a.length > 30);

        for (const mint of mints) {
            const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${mint}`);
            const data = await response.json();
            const pairs = data.pairs || [];
            
            let section = document.getElementById('sec-' + mint);
            if (!section) {
                section = document.createElement('div');
                section.id = 'sec-' + mint;
                section.className = 'token-section';
                grid.appendChild(section);
            }

            let dexHTML = '';
            TARGET_DEX_IDS.forEach(dex => {
                const p = pairs.find(pair => pair.dexId.toLowerCase() === dex.toLowerCase());
                const priceStr = p ? `$${parseFloat(p.priceUsd).toFixed(6)}` : "N/A";
                
                dexHTML += `
                    <div class="dex-card">
                        <div class="dex-name" style="font-size:0.6rem; color:#888;">${dex}</div>
                        <span class="price">${priceStr}</span>
                        <button class="btn-action btn-buy" onclick="executeSwap('BUY', '${mint}', '${dex}')" ${!p ? 'disabled' : ''}>Buy</button>
                        <button class="btn-action btn-sell" onclick="executeSwap('SELL', '${mint}', '${dex}')" ${!p ? 'disabled' : ''}>Sell</button>
                    </div>`;
            });

            section.innerHTML = `
                <div class="token-header">
                    <div class="token-info"><span class="name">${pairs[0]?.baseToken.symbol || '???'}</span> <small>${mint}</small></div>
                </div>
                <div class="dex-grid">${dexHTML}</div>`;
        }
    }

    // Avvio
    setInterval(scan, 30000); 
    scan();
</script>
</body>
</html>
